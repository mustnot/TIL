# JWT (JSON Web Token)

JWT은 웹표준으로서 두 개체 사이에서 JSON 객체를 사용하여 가볍고 자가수용적인 방식으로 정보를 **안전성** 있게 전달한다. JWT에 대해 알아보기 전에 JSON에 대해 알아보자.

JSON (JavaScript Object Notation) 은 속성-값 쌍 혹은 키-값 쌍으로 이루어진 데이터 오브젝트를 전달하기 위해 인간이 읽을 수 있는 텍스트를 사용하는 개방형 표준 포맷이다. 비동기 브라우저/서버 통신 (Ajax)를 위해 넓게는 XML을 대체하는 주요 데이터 포맷이다. 특히 인터넷에서 자료를 주고 받을 때 그 자료를 표현하는 방법으로 알려져 있으며, 자료의 종류에는 큰 제한이 없어 변수값을 표현하는데 적합하다.

<br>

## 구성 요소

JWT는 `.`을 구분자로 3가지의 문자열로 구성되어 있다.

예) aaaa.bbbbb.cccc

* 헤더 (header) : aaaaa
* 내용 (payload) : bbbbb
* 서명 (signature) : ccccc

<br>

### 헤더 (header)

헤더는 `typ`, `alg` 두 가지의 정보를 지니고 있다.

```json
{
	"typ": "JWT",
  "alg": "HS256"
}
```

* typ : 토큰의 타입을 지정 JWT이기에 "JWT"라는 값이 들어간다.
* alg : 해싱 알고리즘을 지정 HMAC, SHA256, RSA가 사용되면 토근을 검증할 때 사용되는 signature 부분에서 사용된다.

<br>

### 정보 (Payload)

Payload 부분에는 토큰을 담을 정보가 들어있다. 정보의 한 조각을 클레임(claim)이라고 부르고, 이는 name/value의 한 쌍으로 이뤄져있다. 토큰에는 여러 개의 클레임들을 넣을 수 있지만 많아질수록 토큰의 길이가 길어진다.

클레임의 종류는 크게 세 분류로 나누어진다.

1. **등록된 (registered) 클레임** : 서비스에서 필요한 정보들이 아닌, 토큰에 대한 정보들을 담기 위하여 이름이 이미 정해진 클레임이다. 등록된 클레임의 사용은 모두 선택(optional)이며, 이에 포함된 클레임은 다음과 같다.
   * `iss` : 토큰 발급자 (issuer)
   * `sub` : 토큰 제목 (subject)
   * `aud` : 토큰 대상자 (audience)
   * `exp` : 토큰의 만료시간(expiration), 시간은 NumericDate 형식으로 되어있어야 하며 언제나 현재 시간보다 이후로 설정되어 있어야 합니다.
   * `nbf` : Not before을 의미하며, 토큰의 활성 날짜와 비슷한 개념입니다. 여기에도 NumericDate형식으로 날짜를 지정하며, 이 날짜가 지정하며, 이 날짜가 지나기 전까지는 토큰이 처리되지 않습니다.
   * `iat` : 토큰이 발급된 시간(issued at), 이 값을 사용하여 토큰의 age가 얼마나 되었는지 판단 할 수 있습니다.
   * `jti` : JWT의 고유 식별자로서, 주로 중복적인 처리를 방지하기 위하여 사용됩니다. 일회용 토큰에 사용하면 유용합니다.

2. **공개 (public) 클레임** : 공개 클ㅋ레임들은 충돌이 방지된 (collision-resistant) 이름을 가지고 있어야한다. 충돌을 방지하기 위해서는 클레임의 이름을 URL 형식으로 짓는다.

   ```json
   {
     "https://aaa.com/jwt/is-active": false
   }
   ```

3. **비공개 (private) 클레임** : 양 측간에 (보통 클라이언트와 서버) 합의하에 사용되는 클레임 이름들로 공개 클레임과는 달리 이름이 중복되어 충돌이 될 수 있으니 사용할 때 유의해야한다.

<br>

### 서명 (signatue)

서명은 헤더의 인코딩 값과 정보의 인코딩 값을 합친 후 주어진 비밀키로 해쉬를 하여 생성한다. 이렇게 만들어진 해쉬를 `base64` 형태로 나타낸다.

<br>

<br>

## 로그인 인증시 JWT 사용

로그인 인증시에도 JWT를 사용한다. 주로 세션을 유지하기 위해서 사용하는데, 이 때 만약 유효기간이 짧은 Token을 발급하게 되면 사용자 입장에서 자주 로그인을 해야하기 때문에 번거롭고 반대로 유효기간이 긴 Token을 발급하게되면 제 3자에게 토큰을 탈취당할 수 있는 보안에 취약하다는 단점이 존재한다.

이런 점을 보완하기 위해 Refresh Token을 사용하는데, Refresh Token은 앞서 로그인에서 발급했던 Access Token과 동일한 JWT 라는 점에서 Access Token의 유효기간이 만료되었을 때, Refresh Token이 새로 발급해주는 열쇠 역할을 한다. 예를 들어, Refresh Token의 유효기간은 1주, Access Token의 유효기간은 1시간이라고 한다면, 사용자는 Access Token으로 1시간동안 API요청을 하다가 시간이 만료되면 Refresh Token을 이용하여 새롭게 발급하면 된다.

이 방법또한 Access Token이 탈취당한다해도 정보가 유출이 되는걸 막을 수 없지만, 더 짧은 유효기간때문에 탈취되는 가능성이 적다는 점을 이용한 것으로 Refresh Token 또한 유효기간이 만료됐다면, 사용자는 새로 로그인해야 하며, Refresh Token도 탈취 될 가능성이 있기 때문에 적절한 유효기간 설정이 필요하다.



