# CSRF란?

**CSRF** (Cross-site Request Forgery) 사이트 간 요청 위조로 **웹사이트 취약점 공격** 중 하나로, 사용자가 자신의 의지와 무관하게 공격자가 의도한 행위(수정, 삭제, 등록 등)를 특정 웹사이트에 요청하게 하는 공격을 말한다. 다른 말로는 크로스 사이트 요청 위조(XSRF)라고도 부른다.

**사이트 간 스크립팅(XSS)**를 이용한 공격이 사용자가 특정 웹사이트를 신용하는 점을 노린 것이라면, **CSRF**는 특정 웹사이트가 사용자의 웹 브라우저를 신용하는 상태를 노린 것이다. 일단 사용자가 웹사이트에 로그인한 상태에서 사이트간 요청 위조 공격 코드가 삽입된 페이지를 열면, 공격 대상이 되는 웹사이트는 위조된 공격 명령이 믿을 수 있는 사용자로부터 발송된 것으로 판단하게 되어 공격에 노출된다.

> 결국 CSRF는 웹 사이트가 사용자를 믿을 수 있다고 판단해놓았을 때 위조된 공격 명령을 사용자로부터 발송하여 공격하는 방법으로 보인다. (맞나 모르겠네)

<br>

## 공격 과정

1. 이용자(사용자)는 웹사이트에 로그인하여 정상적인 **쿠키**를 발급받는다.
2. 공격자는 다음과 같은 **링크**를 이메일이나 게시판 등의 경로를 통해 이용자에게 전달한다.
    * `http://www.geocities.com/attacker`

3. 공격용 HTML 페이지는 다음과 같은 이미지 태그를 가진다.

```html
<img src= "https://travel.service.com/travel_update?.src=Korea&.dst=Hell">
```

4. 이용자가 공격용 페이지를 열면, 브라우저는 이미지 파일을 받아오기 위해 공격용 URL을 연다.

5. 이용자의 승인이나 인지 없이 출발지와 도착지가 등록됨으로써 공격이 완료된다. 해당 서비스 페이지는 등록 과정에 대해 단순히 쿠키를 통한 본인확인 밖에 하지 않으므로 공격자가 정상적인 이용자의 수정이 가능하게 된다.

<br>

### 예시

> 나만 그럴수도 있겠지만, 위에 공격 과정만 들었을 때에는 이해하지 못했다. 그래서 예시를 찾아 내가 이해한 내용대로 설명하면 다음과 같다.

공격 혹은 해킹에 대표적인 예시가 바로 고객의 패스워드를 강제로 변경하는 방법인데, 이를 예시로 들면 특정 웹사이트가 존재하는데 해당 웹사이트에 <u>로그인</u>한 사용자가 패스워드를 변경하고자 하면 일련의 과정을 거치게 되는데, 만약 해당 주소의 패턴이 있어 누구나 위변조가 가능하다면 특정 사용자에게 강제로 패스워드 변경이 가능한 주소를 전달하여 접속하게 하여 사용자의 패스워드를 강제로 변경시켜 공격하는 방법이다. 

음 조금 헷갈릴 수 있는데, 예를 들면 우리가 일반적으로 로그인하는 shopping.com 사이트가 있다고 하면 고객이 패스워드 변경하고자 하면 일련의 과정을 거쳐 패스워드 변경이 가능하다. 하지만 이런 과정에서 url이 공개되어 shopping.com/user.pswd_change?pwd=1111 이라는 주소에 접속하기만 하더라도 접속한 사용자의 패스워드가 변경된다면, 이런 URL을 자유게시판이나 누구나 접근 가능한 곳에 공개하여 접속하게 유도하는 방식이다. (맞는지 모르겠다.)

<br>

<br>

## 방어 방법

> 찾아보니 결국엔 Back 단과 상호 작용이 필요해보인다. 웹에서는 한계가 있는 듯하다.

### Referrer 검증

사용자 요청의 referrer를 확인하여 domain이 기존 요청과 일치하는지 검증하는 방법이 있다. 일반적으로 referrer 검증만으로도 대부분의 CSRF 공격을 방어할 수 있는데, 위 공격 방법만 보더라도 동일한 도메인을 쓰는걸로 봐서 이 방법 역시 취약점이 있다면 공격을 당할 수 있다는 점이 있어보인다.

<br>

### CSRF Token

사용자 세션에 임의의 난수 값을 저장하고 사용자 요청마다 해당 난수 값을 포함 시켜 전송시킨 후에 Back-End 에서 요청 받을 때마다 세션에 저장된 토큰 값과 파라미터에 전달되는 토큰 값이 일치하는지 검증 하는 방법이다. 쉽게 말하면 결국엔 사용자 세션에다가 임의의 토큰 값을 저장하여 특정 요청 시마다 토큰을 비교 검증하여 허용하는 방법으로 볼 수 있는데, 이 방법 역시 취약점이 있을 경우 강제로 검증 결과를 True로 바꾸는 등에 방법을 통해 공격 당할 수 있다. 



## Reference

* [CSRF 공격이란 그리고 CSRF 방어 방법 - 덕's IT Story]([https://itstory.tk/entry/CSRF-%EA%B3%B5%EA%B2%A9%EC%9D%B4%EB%9E%80-%EA%B7%B8%EB%A6%AC%EA%B3%A0-CSRF-%EB%B0%A9%EC%96%B4-%EB%B0%A9%EB%B2%95](https://itstory.tk/entry/CSRF-공격이란-그리고-CSRF-방어-방법))
* [CSRF란? - brownbears](https://brownbears.tistory.com/251)



