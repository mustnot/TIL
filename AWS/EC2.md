# EC2

EC2(Elastic Compute Cloud)는 AWS에서 가장 기본적으로 쓰이는 인프라 중 하나로 인터넷에 연결된 가상 서버를 제공해준다. EC2를 사용하는 이유는 <u>효율성</u>과 <u>비용 절감</u>에 있다. EC2는 클릭 몇 번으로 서버를 생성할 수 있기 때문에 실제 서버를 구축하는 것보다 간편하고 효율적이며, 사용한 만큼만 요금을 지불하면 되므로 비용도 절감할 수 있다.

**EC2 기본 개념**

* 시작 (Start) : 운영체제가 부팅되고 사용할 수 있는 상태로 시작하는 순간부터 사용 요금이 과금되며 <u>1분을 사용하더라도 1시간 요금으로 책정된다.</u>
* 정지 (Stop) : 인스턴스 정지로 운영체제를 종료해 시스템이 정지한 상태로 <u>사용 요금이 과금되지 않는다.</u>
* 삭제 (Terminate) : 인스턴스 삭제로 삭제된 뒤에 목록에서 완전히 사라지려면 시간이 소요된다.
* 재부팅 (Reboot) : 운영체제를 종료한 뒤 다시 시작한다.
* Root 장치 : 운영체제가 설치되는 스토리지로 Root 장치로는 EBS와 인스턴스 스토리지를 사용할 수 있다.
* Kernel ID : 인스턴스가 사용하고 있는 Linux 커널이다. Linux 반가상화는 외부에서 Linux 커널을 지정해줘야한다.

> ℹ️ 운영체제에 따른 가상화 형태
>
> * Windows : OS 커널을 수정할 수 없기에 하드웨어 가상화(HVM), 전가상화(Full Virtualization)로 실행된다. 
> * Linux : 반대로 OS 커널을 수정할 수 있어 반가상화(Paravirtualization)로 실행된다. (때에 따라 전가상화 선택)

> ℹ️ EC2 SLA
>
> SLA(Service Level Agreement)는 월 99.95%로 한 달에 약 0.36시간까지 장애가 발생할 수 있어, EC2를 사용하여 서비스를 구축할 때에는 항상 장애가 발생할 수 있다는 가정하에 설계해야한다.

<br>

## EC2 인스턴스 유형

EC2에서 생성한 가상 서버를 인스턴스라고 한다. 서버 각각을 객체로 본다고 할 수 있는데 마찬가지로 PC와 서버에는 어떤 부품이 사용되었고 성능이 어떤지 알려주는 <u>사양</u>이 있다. EC2의 인스턴스 유형이 여러 가지 사양으로 나뉘어져 있는데, 그 이유는 <u>비용 절감</u>과 <u>효율성</u> 때문이다.

인스턴스 유형은 m3.medium과 같이 인스턴스 패밀리인 m에 세대(Generation)를 뜻하는 숫자가 붙고, 점 뒤에는 전체적인 사양 규모를 뜻하는 단어가 붙는다.

**인스턴스 패밀리**

* 범용 : M1과 M3로 시작하는 인스턴스 유형으로 vCPU, 메모리, 네트워크, 저장 공간 등이 평균 사양으로 제공된다.
* 컴퓨팅 최적화 : C로 시작하는 인스턴스 유형으로 다른 인스턴스 패밀리에 비해 <u>메모리 대비 vCPU 비율이 높다.</u>
* GPU 인스턴스 : G로 시작하는 인스턴스 유형으로 고성능의 NVIDIA GPU가 장착되어 있어 CUDA, OpenCL 등을 실행할 때 사용된다. 
* 메모리 최적화 : M2와 CR1으로 시작하는 인스턴스 유형으로 다른 인스턴스 패밀리에 비해 <u>메모리 용량이 훨씬 크다.</u>
* 스토리지 최적화 : H와 I로 시작하는 인스턴스 유형으로 다른 인스턴스 패밀리보다 <u>스토리지 용량이 훨씬 크거나 초고속 I/O를 제공</u>한다.

* 마이크로 인스턴스 : 가격이 가장 싼 인스턴스로 낮은 vCPU 성능과 적은 메모리를 제공한다. 프리티어에서는 해당 인스턴스 유형을 무료로 사용할 수 있다.

> ℹ️ vCPU
>
> EC2는 가상서버로 EC2 서버는 가상화 소프트웨어(또는 하드웨어 가상화)를 통해 실행되어 가상화 소프트웨어를 통해 제공되는 CPU를 vCPU라고 한다.

<br>

## EC2 인스턴스 구매 옵션

EC2 인스턴스 유형이 여러 가지 사양으로 나눠진 것과 같이 구매 옵션도 여러 가지가 구성되어 있다. 장기간 예약을 하거나 수요가 적은 시간에 인스턴스를 사용하는 방식으로 비용을 절감할 수 있다.

구매 및 과금 방식에 따라 크게 3가지로 구분된다.

* 온 디맨드 인스턴스 (On Demand Instance) : 필요할 때 바로 생성해서 사용할 수 있는 방식으로 과금은 1시간 단위로 이루어지며 1분을 사용했더라도 1시간으로 책정된다. (가장 비싼 요금 방식)
  * 공유 인스턴스 (Shared tenancy) : 하나의 물리적인 서버에 여러 개의 EC2 인스턴스가 실행된다. 다른 인스턴스가 서버 자원을 많이 소모한다면 현재 인스턴스의 성능에 영향이 있을 수 있다.
  * 전용 인스턴스 (Dedicated tenancy) : 하나의 물리적인 서버에 하나의 EC2 인스턴스가 실행되며 공유 인스턴스보다 비용이 비싸다.
* 스팟 인스턴스 (Spot Instance) : 경매 방식의 인스턴스로 인스턴스의 스펙을 설정하고 원하는 가격을 입력하여 입찰하면 수요와 공급에 따라 가격이 결정되고 높게 입찰한 사람한테 인스턴스가 할당된다. 해당 스펙의 인스턴스를 다른 사람이 더 높은 가격으로 입찰했다면 내가 가지고 있는 인스턴스는 종료되는데, 다음과 같은 상황에 적합하다.
  * 클러스터링으로 이루어지는 분석 작업
  * 이미지 변환, 비디오 렌더링
  * 웹 크롤링
  * 각종 테스트
  * 기타 불시에 중단되어도 상관없는 업무
* 예약 인스턴스 (Reserved Instance) : 일정한 예약금을 선불로 내면 인스턴스를 1년 또는 3년 동안 예약할 수 있으며 시간당 요금이 대폭 할인된다. 온 디맨드 인스턴스와 마찬가지로 공유, 전용 인스턴스로 나뉜다.
  * Light 사용률 예약 인스턴스 : 모든 예약 인스턴스 중에서 선결제 금액이 가장 저렴하여 사용 시간이 많지 않을 때 유용하다. 즉 하루 종일 사용하지 않고, 1년 중 몇 달만 사용하는 개발 및 테스트와 단기 프로젝트에 적합하다.
  * Medium 사용률 예약 인스턴스 : Light보다 선결제 금액은 비싸지만 시간당 요금이 저렴하다. 해당 인스턴스는 거의 항상 실행하지만 사용량에 약간의 변화가 있을 때 유용하다.
  * Heavy 사용률 예약 인스턴스 : Medium보다 선결제 금액은 비싸지만 시간당 요금이 가장 저렴하다. 24시간 상시 가동되어야 하는 출시된 제품에 유용하다.

<br>

## 가상 스토리지를 제공하는 EBS

EBS(Elastic Block Store)는 EC2 인스턴스에 장착하여 사용할 수 있는 가상 저장 장치로 EBS는 EC2 인스턴스에서 제공하는 기본 용량보다 더 사용해야 할 때, 운영체제를 중단시키지 않고 용량을 자유롭게 늘리고 싶을 때, 영구적인 데이터 보관이 필요할 때, RAID 등 고급 기능이 필요할 때 사용된다.

EBS는 EC2에 설치된 OS에서 그냥 일반적인 하드디스크나 SSD처럼 인식된다. 원하는 크기로 만들 수 있고, 성능(IOPS) 또한, 원하는 수치로 설정할 수 있다. 그리고 사용자가 삭제하기 전까지는 데이터가 안전하게 유지된다.

**EBS 기본 개념**

* 볼륨 (Volume) : EBS의 가장 기본적인 형태로 OS에서 바로 사용 가능한 형태
* 이미지 (Image) : AMI(Amazon Machine Image)를 줄여 부르는 말로 OS가 설치된 형태로 해당 AMI로 EC2 인스턴스를 생성한다.
* 스냅샷 (Snapshot) : EBS 볼륨의 특정 시점을 그대로 복사해 저장한 파일을 뜻하며, 이 스냅샷을 이용하여 EBS 볼륨과 AMI를 생성할 수 있다.
* IOPS (Input/Output Opeation Per Second) : 저장 장치의 성능 측정 단위로 최소 100 IOPS에서 4,000 IOPS까지 설정할 수 있다.

EC2 인스턴스를 생성할 때 기본적으로 OS가 설치된 EBS 볼륨이 함께 생성된다.

<br>

### EBS 볼륨 생성하기

1. EC2 왼쪽 메뉴에서 Elastic Block Store -> 볼륨 (Volumes) 선택

2. 볼륨 생성 (Create Volume)
   * 볼륨 유형(Type) : EBS 볼륨 형태 (📌 gp : General Purpose)
   * 크기 (Size) : EBS 볼륨 크기
   * IOPS : gp로 선택한 경우 IOPS를 설정할 수 없다. Type을 Provisioned IOPS로 선택해야 설정할 수 있다.
   * 가용 영역 (Availability Zone) : 볼륨이 생성될 가용 영역으로 EC2 인스턴스가 생성된 가용 영역과 같은 곳에 위치해야 EC2 인스턴스에서 사용할 수 있다.
   * 스냅샷 ID : 생성해 놓은 EBS 스냅샷이 있다면 여기서 선택 가능하다.
   * 암호화 (Encryption) : 볼륨 암호화 옵션
   
3. 볼륨 연결 (Attach Volume)

4. 볼륨 포맷하기 : `sudo mkfs -t ext4 /dev/sdf`

   * Ubuntu 20.04 의 경우 `/dev/xvdf ~ /dev/xvdp` 이다.

   ```bash
   $ sudo mkfs -t ext4 /dev/xvdf
   mke2fs 1.45.5 (07-Jan-2020)
   Creating filesystem with 2621440 4k blocks and 655360 inodes
   Filesystem UUID: e753bbf9-894e-4fcc-b068-52379a1ae28e
   Superblock backups stored on blocks:
   	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632
   
   Allocating group tables: done
   Writing inode tables: done
   Creating journal (16384 blocks): done
   Writing superblocks and filesystem accounting information: done
   ```

5. 볼륨 마운트하기 : `sudo mount /dev/sdf /mnt`

6. 볼륨 언마운트하기 : `sudo umount /mnt`

<br>

## EBS 스냅샷 활용하기

스냅샷이란 EBS 볼륨의 전체 내용 중 특정 시점을 파일로 저장한 형태로 EBS 볼륨의 백업 파일의 성격을 지니고 있다.

EBS 스냅샷은 다양한 용도로 활용 가능

* 스냅샷으로 EBS 볼륨 생성 (다른 가용 영역에 생성 가능)
* 스냅샷으로 AMI 생성
* 스냅샷을 다른 리전으로 복사

<br>

### EBS 스냅샷 생성하기

